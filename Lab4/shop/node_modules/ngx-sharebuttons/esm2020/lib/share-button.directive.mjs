import { Directive, Input, Output, HostListener, Inject, EventEmitter } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { EMPTY, Observable, Subject } from 'rxjs';
import { takeUntil, tap } from 'rxjs/operators';
import { SharerMethod } from './share.models';
import { getValidUrl } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/platform-browser";
import * as i2 from "@angular/cdk/platform";
import * as i3 from "@angular/cdk/clipboard";
import * as i4 from "./share.service";
export class ShareDirective {
    constructor(_el, _meta, _platform, _clipboard, _share, _cd, _document) {
        this._meta = _meta;
        this._platform = _platform;
        this._clipboard = _clipboard;
        this._share = _share;
        this._cd = _cd;
        this._document = _document;
        /** Stream that emits when button is destroyed */
        this._destroyed = new Subject();
        /** Stream that emit when share button need to be updated */
        this._updater = new Subject();
        /** Set meta tags from document head, useful when SEO is supported */
        this.autoSetMeta = this._share.config.autoSetMeta;
        /** Sharing link */
        this.url = this._share.config.url;
        /** Sets the title parameter */
        this.title = this._share.config.title;
        /** Sets the description parameter */
        this.description = this._share.config.description;
        /** Sets the image parameter for sharing on Pinterest */
        this.image = this._share.config.image;
        /** Sets the tags parameter for sharing on Twitter and Tumblr */
        this.tags = this._share.config.tags;
        /** Stream that emits when share dialog is opened */
        this.opened = new EventEmitter();
        /** Stream that emits when share dialog is closed */
        this.closed = new EventEmitter();
        this._el = _el.nativeElement;
    }
    /**
     * Share the link
     */
    share() {
        // Avoid SSR error
        if (this._platform.isBrowser && this.shareButton) {
            // Prepare sharer url params
            const params = this.autoSetMeta ? this.getParamsFromMetaTags() : this.getParamsFromInputs();
            // Prepare share button click
            const click = this.shareButton.share ? this.open(params) : this.shareButton.func({
                params,
                data: this.shareButton.data,
                clipboard: this._clipboard,
                updater: this._updater
            });
            click.pipe(takeUntil(this._destroyed)).subscribe();
        }
        else {
            console.warn(`${this.text} button is not compatible on this Platform`);
        }
    }
    ngOnInit() {
        // This stream is mainly used to update the copy button text and icon when it is being clicked
        this._updater.pipe(tap((data) => {
            this.icon = data.icon;
            this.text = data.text;
            this._el.style.pointerEvents = data.disabled ? 'none' : 'auto';
            this._cd.markForCheck();
        }), takeUntil(this._destroyed)).subscribe();
    }
    ngOnChanges(changes) {
        // Avoid SSR error
        if (this._platform.isBrowser) {
            // Create share button
            if (this._shareButtonChanged(changes.shareButtonName)) {
                this._createShareButton();
            }
            // Prepare share url
            if (this._urlChanged(changes.url)) {
                this.url = getValidUrl(this.autoSetMeta
                    ? this.url || this._getMetaTagContent('og:url')
                    : this.url, this._document.defaultView.location.href);
            }
        }
    }
    ngOnDestroy() {
        this._destroyed.next();
        this._destroyed.complete();
    }
    _createShareButton() {
        const button = this._share.config.prop[this.shareButtonName];
        if (button) {
            // Set share button properties
            this.shareButton = button;
            // Remove previous button class
            this._el.classList.remove(`sb-${this._buttonClass}`);
            // Add new button class
            this._el.classList.add(`sb-${this.shareButtonName}`);
            // Set button css color variable
            this._el.style.setProperty('--button-color', this.shareButton.color);
            // Keep a copy of the class for future replacement
            this._buttonClass = this.shareButtonName;
            this.color = this.shareButton.color;
            this.text = this.shareButton.text;
            this.icon = this.shareButton.icon;
            // Set aria-label attribute
            this._el.setAttribute('aria-label', button.ariaLabel);
        }
        else {
            console.error(`[ShareButtons]: The share button '${this.shareButtonName}' does not exist!`);
        }
    }
    /**
     * Get meta tag content
     */
    _getMetaTagContent(key) {
        const metaUsingProperty = this._meta.getTag(`property="${key}"`);
        if (metaUsingProperty) {
            return metaUsingProperty.getAttribute('content');
        }
        const metaUsingName = this._meta.getTag(`name="${key}"`);
        if (metaUsingName) {
            return metaUsingName.getAttribute('content');
        }
    }
    _shareButtonChanged(change) {
        return change && (change.firstChange || change.previousValue !== change.currentValue);
    }
    _urlChanged(change) {
        return !this.url || (change && change.previousValue !== change.currentValue);
    }
    /**
     * Get share params from meta tags first and fallback to user inputs
     */
    getParamsFromMetaTags() {
        return {
            url: this.url,
            title: this.title || this._getMetaTagContent('og:title'),
            description: this.description || this._getMetaTagContent('og:description'),
            image: this.image || this._getMetaTagContent('og:image'),
            via: this._share.config.twitterAccount,
            tags: this.tags
        };
    }
    /**
     * Get share params from user inputs
     */
    getParamsFromInputs() {
        return {
            url: this.url,
            title: this.title,
            description: this.description,
            image: this.image,
            tags: this.tags,
            via: this._share.config.twitterAccount,
        };
    }
    open(params) {
        // Set sharer link based on user's device
        let sharerLink;
        if (this._platform.IOS && this.shareButton.share.ios) {
            sharerLink = this.shareButton.share.ios;
        }
        else if (this._platform.ANDROID && this.shareButton.share.android) {
            sharerLink = this.shareButton.share.android;
        }
        else {
            sharerLink = this.shareButton.share.desktop;
        }
        if (sharerLink) {
            // Set sharer link params
            this._finalUrl = sharerLink + this._serializeParams(params);
            // Log the sharer link in debug mode
            if (this._share.config.debug) {
                console.log('[DEBUG SHARE BUTTON]: ', this._finalUrl);
            }
            // Open the share window
            // There are two methods available for opening the share window:
            // 1. Using a real anchor
            // 2. Using window.open
            const sharerMethod = this.shareButton.method || this._share.config.sharerMethod;
            const sharerTarget = this.shareButton.target || this._share.config.sharerTarget;
            switch (sharerMethod) {
                case SharerMethod.Anchor:
                    const linkElement = this._document.createElement('a');
                    // Make it open in a new tab/window (depends on user's browser configuration)
                    linkElement.setAttribute('target', sharerTarget);
                    // Prevent security vulnerability https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c
                    linkElement.setAttribute('rel', 'noopener noreferrer');
                    linkElement.href = this._finalUrl;
                    linkElement.click();
                    linkElement.remove();
                    break;
                case SharerMethod.Window:
                    // Open link using Window object
                    const openWindow = this._share.config.windowObj[this._share.config.windowFuncName];
                    const popUpWindow = openWindow(this._finalUrl, sharerTarget, this._share.windowSize);
                    // Prevent security vulnerability https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c
                    this._share.config.windowObj.opener = null;
                    // Resolve when share dialog is closed
                    if (popUpWindow) {
                        return new Observable((sub) => {
                            const pollTimer = this._document.defaultView.setInterval(() => {
                                if (popUpWindow.closed) {
                                    this._document.defaultView.clearInterval(pollTimer);
                                    // Emit when share windows is closed
                                    this.closed.emit(this.shareButtonName);
                                    sub.next();
                                    sub.complete();
                                }
                            }, 200);
                        });
                    }
                    break;
            }
            // Emit when share window is opened
            this.opened.emit(this.shareButtonName);
        }
        return EMPTY;
    }
    _serializeParams(params) {
        return Object.entries(this.shareButton.params)
            .map(([key, value]) => {
            // Check if share button param has a map function
            const paramFunc = this.shareButton.paramsFunc ? this.shareButton.paramsFunc[key] : null;
            if (params[key] || paramFunc) {
                const paramValue = paramFunc ? paramFunc(params) : params[key];
                return `${value}=${encodeURIComponent(paramValue)}`;
            }
            return '';
        })
            .filter(urlParam => urlParam !== '')
            .join('&');
    }
}
ShareDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.0.0", ngImport: i0, type: ShareDirective, deps: [{ token: i0.ElementRef }, { token: i1.Meta }, { token: i2.Platform }, { token: i3.Clipboard }, { token: i4.ShareService }, { token: i0.ChangeDetectorRef }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Directive });
ShareDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "14.0.0", type: ShareDirective, selector: "[shareButton]", inputs: { shareButtonName: ["shareButton", "shareButtonName"], autoSetMeta: "autoSetMeta", url: "url", title: "title", description: "description", image: "image", tags: "tags" }, outputs: { opened: "opened", closed: "closed" }, host: { listeners: { "click": "share()" } }, exportAs: ["shareButton"], usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.0.0", ngImport: i0, type: ShareDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[shareButton]',
                    exportAs: 'shareButton'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.Meta }, { type: i2.Platform }, { type: i3.Clipboard }, { type: i4.ShareService }, { type: i0.ChangeDetectorRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; }, propDecorators: { shareButtonName: [{
                type: Input,
                args: ['shareButton']
            }], autoSetMeta: [{
                type: Input
            }], url: [{
                type: Input
            }], title: [{
                type: Input
            }], description: [{
                type: Input
            }], image: [{
                type: Input
            }], tags: [{
                type: Input
            }], opened: [{
                type: Output
            }], closed: [{
                type: Output
            }], share: [{
                type: HostListener,
                args: ['click']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtYnV0dG9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1zaGFyZWJ1dHRvbnMvc3JjL2xpYi9zaGFyZS1idXR0b24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osTUFBTSxFQU1OLFlBQVksRUFHYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFJM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHaEQsT0FBTyxFQUFxRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqSCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7Ozs7QUFNdEMsTUFBTSxPQUFPLGNBQWM7SUF3RHpCLFlBQVksR0FBZSxFQUNQLEtBQVcsRUFDWCxTQUFtQixFQUNuQixVQUFxQixFQUNyQixNQUFvQixFQUNwQixHQUFzQixFQUNKLFNBQWM7UUFMaEMsVUFBSyxHQUFMLEtBQUssQ0FBTTtRQUNYLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFDbkIsZUFBVSxHQUFWLFVBQVUsQ0FBVztRQUNyQixXQUFNLEdBQU4sTUFBTSxDQUFjO1FBQ3BCLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ0osY0FBUyxHQUFULFNBQVMsQ0FBSztRQW5EcEQsaURBQWlEO1FBQ2hDLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBRWxELDREQUE0RDtRQUMzQyxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQXlCLENBQUM7UUFpQmpFLHFFQUFxRTtRQUM1RCxnQkFBVyxHQUFZ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RSxhQUFhO2lCQUN4Qjs7MEJBK0RjLE1BQU07MkJBQUMsUUFBUTs0Q0FoQ04sZUFBZTtzQkFBcEMsS0FBSzt1QkFBQyxhQUFhO2dCQUdYLFdBQVc7c0JBQW5CLEtBQUs7Z0JBR0csR0FBRztzQkFBWCxLQUFLO2dCQUdHLEtBQUs7c0JBQWIsS0FBSztnQkFHRyxXQUFXO3NCQUFuQixLQUFLO2dCQUdHLEtBQUs7c0JBQWIsS0FBSztnQkFHRyxJQUFJO3NCQUFaLEtBQUs7Z0JBR0ksTUFBTTtzQkFBZixNQUFNO2dCQUdHLE1BQU07c0JBQWYsTUFBTTtnQkFnQlAsS0FBSztzQkFESixZQUFZO3VCQUFDLE9BQU8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgSG9zdExpc3RlbmVyLFxyXG4gIEluamVjdCxcclxuICBPbkluaXQsXHJcbiAgT25DaGFuZ2VzLFxyXG4gIE9uRGVzdHJveSxcclxuICBTaW1wbGVDaGFuZ2VzLFxyXG4gIFNpbXBsZUNoYW5nZSxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgRWxlbWVudFJlZixcclxuICBDaGFuZ2VEZXRlY3RvclJlZlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IE1ldGEgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBDbGlwYm9hcmQgfSBmcm9tICdAYW5ndWxhci9jZGsvY2xpcGJvYXJkJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmliZXIgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBTaGFyZVNlcnZpY2UgfSBmcm9tICcuL3NoYXJlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBJU2hhcmVCdXR0b24sIFNoYXJlRGlyZWN0aXZlVXBkYXRlciwgU2hhcmVQYXJhbXMsIFNoYXJlUGFyYW1zRnVuYywgU2hhcmVyTWV0aG9kIH0gZnJvbSAnLi9zaGFyZS5tb2RlbHMnO1xyXG5pbXBvcnQgeyBnZXRWYWxpZFVybCB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbc2hhcmVCdXR0b25dJyxcclxuICBleHBvcnRBczogJ3NoYXJlQnV0dG9uJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgU2hhcmVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuXHJcbiAgLyoqIFZhcmlhYmxlIHVzZWQgdG8gY2hlY2sgZm9yIHRoZSBmaW5hbCBzaGFyZXIgdXJsIChGb3IgdGVzdGluZyBvbmx5KSAqL1xyXG4gIHByaXZhdGUgX2ZpbmFsVXJsOiBzdHJpbmc7XHJcblxyXG4gIC8qKiBTaGFyZSBkaXJlY3RpdmUgZWxlbWVudCByZWYgKi9cclxuICBwcml2YXRlIHJlYWRvbmx5IF9lbDogSFRNTEJ1dHRvbkVsZW1lbnQ7XHJcblxyXG4gIC8qKiBBIHJlZiB0byBidXR0b24gY2xhc3MgLSB1c2VkIHRvIHJlbW92ZSBwcmV2aW91cyBjbGFzcyB3aGVuIHRoZSBidXR0b24gdHlwZSBpcyBjaGFuZ2VkICovXHJcbiAgcHJpdmF0ZSBfYnV0dG9uQ2xhc3M6IHN0cmluZztcclxuXHJcbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gYnV0dG9uIGlzIGRlc3Ryb3llZCAqL1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2Rlc3Ryb3llZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcblxyXG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0IHdoZW4gc2hhcmUgYnV0dG9uIG5lZWQgdG8gYmUgdXBkYXRlZCAqL1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3VwZGF0ZXIgPSBuZXcgU3ViamVjdDxTaGFyZURpcmVjdGl2ZVVwZGF0ZXI+KCk7XHJcblxyXG4gIC8qKiBTaGFyZSBidXR0b24gcHJvcGVydGllcyAqL1xyXG4gIHNoYXJlQnV0dG9uOiBJU2hhcmVCdXR0b247XHJcblxyXG4gIC8qKiBTaGFyZSBidXR0b24gY29sb3IgKi9cclxuICBjb2xvcjogc3RyaW5nO1xyXG5cclxuICAvKiogU2hhcmUgYnV0dG9uIHRleHQgKi9cclxuICB0ZXh0OiBzdHJpbmc7XHJcblxyXG4gIC8qKiBTaGFyZSBidXR0b24gaWNvbiAqL1xyXG4gIGljb246IHN0cmluZyB8IHN0cmluZ1tdO1xyXG5cclxuICAvKiogU2hhcmUgYnV0dG9uIHR5cGUgKi9cclxuICBASW5wdXQoJ3NoYXJlQnV0dG9uJykgc2hhcmVCdXR0b25OYW1lOiBzdHJpbmc7XHJcblxyXG4gIC8qKiBTZXQgbWV0YSB0YWdzIGZyb20gZG9jdW1lbnQgaGVhZCwgdXNlZnVsIHdoZW4gU0VPIGlzIHN1cHBvcnRlZCAqL1xyXG4gIEBJbnB1dCgpIGF1dG9TZXRNZXRhOiBib29sZWFuID0gdGhpcy5fc2hhcmUuY29uZmlnLmF1dG9TZXRNZXRhO1xyXG5cclxuICAvKiogU2hhcmluZyBsaW5rICovXHJcbiAgQElucHV0KCkgdXJsOiBzdHJpbmcgPSB0aGlzLl9zaGFyZS5jb25maWcudXJsO1xyXG5cclxuICAvKiogU2V0cyB0aGUgdGl0bGUgcGFyYW1ldGVyICovXHJcbiAgQElucHV0KCkgdGl0bGU6IHN0cmluZyA9IHRoaXMuX3NoYXJlLmNvbmZpZy50aXRsZTtcclxuXHJcbiAgLyoqIFNldHMgdGhlIGRlc2NyaXB0aW9uIHBhcmFtZXRlciAqL1xyXG4gIEBJbnB1dCgpIGRlc2NyaXB0aW9uOiBzdHJpbmcgPSB0aGlzLl9zaGFyZS5jb25maWcuZGVzY3JpcHRpb247XHJcblxyXG4gIC8qKiBTZXRzIHRoZSBpbWFnZSBwYXJhbWV0ZXIgZm9yIHNoYXJpbmcgb24gUGludGVyZXN0ICovXHJcbiAgQElucHV0KCkgaW1hZ2U6IHN0cmluZyA9IHRoaXMuX3NoYXJlLmNvbmZpZy5pbWFnZTtcclxuXHJcbiAgLyoqIFNldHMgdGhlIHRhZ3MgcGFyYW1ldGVyIGZvciBzaGFyaW5nIG9uIFR3aXR0ZXIgYW5kIFR1bWJsciAqL1xyXG4gIEBJbnB1dCgpIHRhZ3M6IHN0cmluZyA9IHRoaXMuX3NoYXJlLmNvbmZpZy50YWdzO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzaGFyZSBkaWFsb2cgaXMgb3BlbmVkICovXHJcbiAgQE91dHB1dCgpIG9wZW5lZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICAvKiogU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzaGFyZSBkaWFsb2cgaXMgY2xvc2VkICovXHJcbiAgQE91dHB1dCgpIGNsb3NlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICBjb25zdHJ1Y3RvcihfZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfbWV0YTogTWV0YSxcclxuICAgICAgICAgICAgICBwcml2YXRlIF9wbGF0Zm9ybTogUGxhdGZvcm0sXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfY2xpcGJvYXJkOiBDbGlwYm9hcmQsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfc2hhcmU6IFNoYXJlU2VydmljZSxcclxuICAgICAgICAgICAgICBwcml2YXRlIF9jZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICAgICAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBfZG9jdW1lbnQ6IGFueSkge1xyXG4gICAgdGhpcy5fZWwgPSBfZWwubmF0aXZlRWxlbWVudDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNoYXJlIHRoZSBsaW5rXHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxyXG4gIHNoYXJlKCkge1xyXG4gICAgLy8gQXZvaWQgU1NSIGVycm9yXHJcbiAgICBpZiAodGhpcy5fcGxhdGZvcm0uaXNCcm93c2VyICYmIHRoaXMuc2hhcmVCdXR0b24pIHtcclxuICAgICAgLy8gUHJlcGFyZSBzaGFyZXIgdXJsIHBhcmFtc1xyXG4gICAgICBjb25zdCBwYXJhbXM6IFNoYXJlUGFyYW1zID0gdGhpcy5hdXRvU2V0TWV0YSA/IHRoaXMuZ2V0UGFyYW1zRnJvbU1ldGFUYWdzKCkgOiB0aGlzLmdldFBhcmFtc0Zyb21JbnB1dHMoKTtcclxuXHJcbiAgICAgIC8vIFByZXBhcmUgc2hhcmUgYnV0dG9uIGNsaWNrXHJcbiAgICAgIGNvbnN0IGNsaWNrID0gdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZSA/IHRoaXMub3BlbihwYXJhbXMpIDogdGhpcy5zaGFyZUJ1dHRvbi5mdW5jKHtcclxuICAgICAgICBwYXJhbXMsXHJcbiAgICAgICAgZGF0YTogdGhpcy5zaGFyZUJ1dHRvbi5kYXRhLFxyXG4gICAgICAgIGNsaXBib2FyZDogdGhpcy5fY2xpcGJvYXJkLFxyXG4gICAgICAgIHVwZGF0ZXI6IHRoaXMuX3VwZGF0ZXJcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjbGljay5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQpKS5zdWJzY3JpYmUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihgJHsgdGhpcy50ZXh0IH0gYnV0dG9uIGlzIG5vdCBjb21wYXRpYmxlIG9uIHRoaXMgUGxhdGZvcm1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgLy8gVGhpcyBzdHJlYW0gaXMgbWFpbmx5IHVzZWQgdG8gdXBkYXRlIHRoZSBjb3B5IGJ1dHRvbiB0ZXh0IGFuZCBpY29uIHdoZW4gaXQgaXMgYmVpbmcgY2xpY2tlZFxyXG4gICAgdGhpcy5fdXBkYXRlci5waXBlKFxyXG4gICAgICB0YXAoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIHRoaXMuaWNvbiA9IGRhdGEuaWNvbjtcclxuICAgICAgICB0aGlzLnRleHQgPSBkYXRhLnRleHQ7XHJcbiAgICAgICAgdGhpcy5fZWwuc3R5bGUucG9pbnRlckV2ZW50cyA9IGRhdGEuZGlzYWJsZWQgPyAnbm9uZScgOiAnYXV0byc7XHJcbiAgICAgICAgdGhpcy5fY2QubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgIH0pLFxyXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkKVxyXG4gICAgKS5zdWJzY3JpYmUoKTtcclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIC8vIEF2b2lkIFNTUiBlcnJvclxyXG4gICAgaWYgKHRoaXMuX3BsYXRmb3JtLmlzQnJvd3Nlcikge1xyXG5cclxuICAgICAgLy8gQ3JlYXRlIHNoYXJlIGJ1dHRvblxyXG4gICAgICBpZiAodGhpcy5fc2hhcmVCdXR0b25DaGFuZ2VkKGNoYW5nZXMuc2hhcmVCdXR0b25OYW1lKSkge1xyXG4gICAgICAgIHRoaXMuX2NyZWF0ZVNoYXJlQnV0dG9uKCk7XHJcbiAgICAgIH1cclxuICAgICAgLy8gUHJlcGFyZSBzaGFyZSB1cmxcclxuICAgICAgaWYgKHRoaXMuX3VybENoYW5nZWQoY2hhbmdlcy51cmwpKSB7XHJcbiAgICAgICAgdGhpcy51cmwgPSBnZXRWYWxpZFVybChcclxuICAgICAgICAgIHRoaXMuYXV0b1NldE1ldGFcclxuICAgICAgICAgICAgPyB0aGlzLnVybCB8fCB0aGlzLl9nZXRNZXRhVGFnQ29udGVudCgnb2c6dXJsJylcclxuICAgICAgICAgICAgOiB0aGlzLnVybCxcclxuICAgICAgICAgIHRoaXMuX2RvY3VtZW50LmRlZmF1bHRWaWV3LmxvY2F0aW9uLmhyZWZcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuX2Rlc3Ryb3llZC5uZXh0KCk7XHJcbiAgICB0aGlzLl9kZXN0cm95ZWQuY29tcGxldGUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2NyZWF0ZVNoYXJlQnV0dG9uKCkge1xyXG4gICAgY29uc3QgYnV0dG9uOiBJU2hhcmVCdXR0b24gPSB0aGlzLl9zaGFyZS5jb25maWcucHJvcFt0aGlzLnNoYXJlQnV0dG9uTmFtZV07XHJcbiAgICBpZiAoYnV0dG9uKSB7XHJcbiAgICAgIC8vIFNldCBzaGFyZSBidXR0b24gcHJvcGVydGllc1xyXG4gICAgICB0aGlzLnNoYXJlQnV0dG9uID0gYnV0dG9uO1xyXG5cclxuICAgICAgLy8gUmVtb3ZlIHByZXZpb3VzIGJ1dHRvbiBjbGFzc1xyXG4gICAgICB0aGlzLl9lbC5jbGFzc0xpc3QucmVtb3ZlKGBzYi0keyB0aGlzLl9idXR0b25DbGFzcyB9YCk7XHJcblxyXG4gICAgICAvLyBBZGQgbmV3IGJ1dHRvbiBjbGFzc1xyXG4gICAgICB0aGlzLl9lbC5jbGFzc0xpc3QuYWRkKGBzYi0keyB0aGlzLnNoYXJlQnV0dG9uTmFtZSB9YCk7XHJcblxyXG4gICAgICAvLyBTZXQgYnV0dG9uIGNzcyBjb2xvciB2YXJpYWJsZVxyXG4gICAgICB0aGlzLl9lbC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS1idXR0b24tY29sb3InLCB0aGlzLnNoYXJlQnV0dG9uLmNvbG9yKTtcclxuXHJcbiAgICAgIC8vIEtlZXAgYSBjb3B5IG9mIHRoZSBjbGFzcyBmb3IgZnV0dXJlIHJlcGxhY2VtZW50XHJcbiAgICAgIHRoaXMuX2J1dHRvbkNsYXNzID0gdGhpcy5zaGFyZUJ1dHRvbk5hbWU7XHJcblxyXG4gICAgICB0aGlzLmNvbG9yID0gdGhpcy5zaGFyZUJ1dHRvbi5jb2xvcjtcclxuICAgICAgdGhpcy50ZXh0ID0gdGhpcy5zaGFyZUJ1dHRvbi50ZXh0O1xyXG4gICAgICB0aGlzLmljb24gPSB0aGlzLnNoYXJlQnV0dG9uLmljb247XHJcblxyXG4gICAgICAvLyBTZXQgYXJpYS1sYWJlbCBhdHRyaWJ1dGVcclxuICAgICAgdGhpcy5fZWwuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgYnV0dG9uLmFyaWFMYWJlbCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBbU2hhcmVCdXR0b25zXTogVGhlIHNoYXJlIGJ1dHRvbiAnJHsgdGhpcy5zaGFyZUJ1dHRvbk5hbWUgfScgZG9lcyBub3QgZXhpc3QhYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgbWV0YSB0YWcgY29udGVudFxyXG4gICAqL1xyXG4gIHByaXZhdGUgX2dldE1ldGFUYWdDb250ZW50KGtleTogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IG1ldGFVc2luZ1Byb3BlcnR5OiBIVE1MTWV0YUVsZW1lbnQgPSB0aGlzLl9tZXRhLmdldFRhZyhgcHJvcGVydHk9XCIkeyBrZXkgfVwiYCk7XHJcbiAgICBpZiAobWV0YVVzaW5nUHJvcGVydHkpIHtcclxuICAgICAgcmV0dXJuIG1ldGFVc2luZ1Byb3BlcnR5LmdldEF0dHJpYnV0ZSgnY29udGVudCcpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWV0YVVzaW5nTmFtZTogSFRNTE1ldGFFbGVtZW50ID0gdGhpcy5fbWV0YS5nZXRUYWcoYG5hbWU9XCIkeyBrZXkgfVwiYCk7XHJcbiAgICBpZiAobWV0YVVzaW5nTmFtZSkge1xyXG4gICAgICByZXR1cm4gbWV0YVVzaW5nTmFtZS5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3NoYXJlQnV0dG9uQ2hhbmdlZChjaGFuZ2U6IFNpbXBsZUNoYW5nZSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGNoYW5nZSAmJiAoY2hhbmdlLmZpcnN0Q2hhbmdlIHx8IGNoYW5nZS5wcmV2aW91c1ZhbHVlICE9PSBjaGFuZ2UuY3VycmVudFZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3VybENoYW5nZWQoY2hhbmdlOiBTaW1wbGVDaGFuZ2UpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhdGhpcy51cmwgfHwgKGNoYW5nZSAmJiBjaGFuZ2UucHJldmlvdXNWYWx1ZSAhPT0gY2hhbmdlLmN1cnJlbnRWYWx1ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgc2hhcmUgcGFyYW1zIGZyb20gbWV0YSB0YWdzIGZpcnN0IGFuZCBmYWxsYmFjayB0byB1c2VyIGlucHV0c1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UGFyYW1zRnJvbU1ldGFUYWdzKCk6IFNoYXJlUGFyYW1zIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHVybDogdGhpcy51cmwsXHJcbiAgICAgIHRpdGxlOiB0aGlzLnRpdGxlIHx8IHRoaXMuX2dldE1ldGFUYWdDb250ZW50KCdvZzp0aXRsZScpLFxyXG4gICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbiB8fCB0aGlzLl9nZXRNZXRhVGFnQ29udGVudCgnb2c6ZGVzY3JpcHRpb24nKSxcclxuICAgICAgaW1hZ2U6IHRoaXMuaW1hZ2UgfHwgdGhpcy5fZ2V0TWV0YVRhZ0NvbnRlbnQoJ29nOmltYWdlJyksXHJcbiAgICAgIHZpYTogdGhpcy5fc2hhcmUuY29uZmlnLnR3aXR0ZXJBY2NvdW50LFxyXG4gICAgICB0YWdzOiB0aGlzLnRhZ3NcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBHZXQgc2hhcmUgcGFyYW1zIGZyb20gdXNlciBpbnB1dHNcclxuICAgKi9cclxuICBwcml2YXRlIGdldFBhcmFtc0Zyb21JbnB1dHMoKTogU2hhcmVQYXJhbXMge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdXJsOiB0aGlzLnVybCxcclxuICAgICAgdGl0bGU6IHRoaXMudGl0bGUsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLmRlc2NyaXB0aW9uLFxyXG4gICAgICBpbWFnZTogdGhpcy5pbWFnZSxcclxuICAgICAgdGFnczogdGhpcy50YWdzLFxyXG4gICAgICB2aWE6IHRoaXMuX3NoYXJlLmNvbmZpZy50d2l0dGVyQWNjb3VudCxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9wZW4ocGFyYW1zOiBTaGFyZVBhcmFtcyk6IE9ic2VydmFibGU8dm9pZD4ge1xyXG4gICAgLy8gU2V0IHNoYXJlciBsaW5rIGJhc2VkIG9uIHVzZXIncyBkZXZpY2VcclxuICAgIGxldCBzaGFyZXJMaW5rOiBzdHJpbmc7XHJcbiAgICBpZiAodGhpcy5fcGxhdGZvcm0uSU9TICYmIHRoaXMuc2hhcmVCdXR0b24uc2hhcmUuaW9zKSB7XHJcbiAgICAgIHNoYXJlckxpbmsgPSB0aGlzLnNoYXJlQnV0dG9uLnNoYXJlLmlvcztcclxuICAgIH0gZWxzZSBpZiAodGhpcy5fcGxhdGZvcm0uQU5EUk9JRCAmJiB0aGlzLnNoYXJlQnV0dG9uLnNoYXJlLmFuZHJvaWQpIHtcclxuICAgICAgc2hhcmVyTGluayA9IHRoaXMuc2hhcmVCdXR0b24uc2hhcmUuYW5kcm9pZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNoYXJlckxpbmsgPSB0aGlzLnNoYXJlQnV0dG9uLnNoYXJlLmRlc2t0b3A7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNoYXJlckxpbmspIHtcclxuICAgICAgLy8gU2V0IHNoYXJlciBsaW5rIHBhcmFtc1xyXG4gICAgICB0aGlzLl9maW5hbFVybCA9IHNoYXJlckxpbmsgKyB0aGlzLl9zZXJpYWxpemVQYXJhbXMocGFyYW1zKTtcclxuXHJcbiAgICAgIC8vIExvZyB0aGUgc2hhcmVyIGxpbmsgaW4gZGVidWcgbW9kZVxyXG4gICAgICBpZiAodGhpcy5fc2hhcmUuY29uZmlnLmRlYnVnKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ1tERUJVRyBTSEFSRSBCVVRUT05dOiAnLCB0aGlzLl9maW5hbFVybCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIE9wZW4gdGhlIHNoYXJlIHdpbmRvd1xyXG4gICAgICAvLyBUaGVyZSBhcmUgdHdvIG1ldGhvZHMgYXZhaWxhYmxlIGZvciBvcGVuaW5nIHRoZSBzaGFyZSB3aW5kb3c6XHJcbiAgICAgIC8vIDEuIFVzaW5nIGEgcmVhbCBhbmNob3JcclxuICAgICAgLy8gMi4gVXNpbmcgd2luZG93Lm9wZW5cclxuICAgICAgY29uc3Qgc2hhcmVyTWV0aG9kID0gdGhpcy5zaGFyZUJ1dHRvbi5tZXRob2QgfHwgdGhpcy5fc2hhcmUuY29uZmlnLnNoYXJlck1ldGhvZDtcclxuICAgICAgY29uc3Qgc2hhcmVyVGFyZ2V0ID0gdGhpcy5zaGFyZUJ1dHRvbi50YXJnZXQgfHwgdGhpcy5fc2hhcmUuY29uZmlnLnNoYXJlclRhcmdldDtcclxuXHJcbiAgICAgIHN3aXRjaCAoc2hhcmVyTWV0aG9kKSB7XHJcblxyXG4gICAgICAgIGNhc2UgU2hhcmVyTWV0aG9kLkFuY2hvcjpcclxuICAgICAgICAgIGNvbnN0IGxpbmtFbGVtZW50OiBIVE1MTGlua0VsZW1lbnQgPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XHJcbiAgICAgICAgICAvLyBNYWtlIGl0IG9wZW4gaW4gYSBuZXcgdGFiL3dpbmRvdyAoZGVwZW5kcyBvbiB1c2VyJ3MgYnJvd3NlciBjb25maWd1cmF0aW9uKVxyXG4gICAgICAgICAgbGlua0VsZW1lbnQuc2V0QXR0cmlidXRlKCd0YXJnZXQnLCBzaGFyZXJUYXJnZXQpO1xyXG5cclxuICAgICAgICAgIC8vIFByZXZlbnQgc2VjdXJpdHkgdnVsbmVyYWJpbGl0eSBodHRwczovL21lZGl1bS5jb20vQGppdGJpdC90YXJnZXQtYmxhbmstdGhlLW1vc3QtdW5kZXJlc3RpbWF0ZWQtdnVsbmVyYWJpbGl0eS1ldmVyLTk2ZTMyODMwMWY0Y1xyXG4gICAgICAgICAgbGlua0VsZW1lbnQuc2V0QXR0cmlidXRlKCdyZWwnLCAnbm9vcGVuZXIgbm9yZWZlcnJlcicpO1xyXG4gICAgICAgICAgbGlua0VsZW1lbnQuaHJlZiA9IHRoaXMuX2ZpbmFsVXJsO1xyXG4gICAgICAgICAgbGlua0VsZW1lbnQuY2xpY2soKTtcclxuICAgICAgICAgIGxpbmtFbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgIGNhc2UgU2hhcmVyTWV0aG9kLldpbmRvdzpcclxuICAgICAgICAgIC8vIE9wZW4gbGluayB1c2luZyBXaW5kb3cgb2JqZWN0XHJcbiAgICAgICAgICBjb25zdCBvcGVuV2luZG93ID0gdGhpcy5fc2hhcmUuY29uZmlnLndpbmRvd09ialt0aGlzLl9zaGFyZS5jb25maWcud2luZG93RnVuY05hbWVdO1xyXG4gICAgICAgICAgY29uc3QgcG9wVXBXaW5kb3cgPSBvcGVuV2luZG93KHRoaXMuX2ZpbmFsVXJsLCBzaGFyZXJUYXJnZXQsIHRoaXMuX3NoYXJlLndpbmRvd1NpemUpO1xyXG5cclxuICAgICAgICAgIC8vIFByZXZlbnQgc2VjdXJpdHkgdnVsbmVyYWJpbGl0eSBodHRwczovL21lZGl1bS5jb20vQGppdGJpdC90YXJnZXQtYmxhbmstdGhlLW1vc3QtdW5kZXJlc3RpbWF0ZWQtdnVsbmVyYWJpbGl0eS1ldmVyLTk2ZTMyODMwMWY0Y1xyXG4gICAgICAgICAgdGhpcy5fc2hhcmUuY29uZmlnLndpbmRvd09iai5vcGVuZXIgPSBudWxsO1xyXG5cclxuICAgICAgICAgIC8vIFJlc29sdmUgd2hlbiBzaGFyZSBkaWFsb2cgaXMgY2xvc2VkXHJcbiAgICAgICAgICBpZiAocG9wVXBXaW5kb3cpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPHZvaWQ+KChzdWI6IFN1YnNjcmliZXI8dm9pZD4pID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBwb2xsVGltZXIgPSB0aGlzLl9kb2N1bWVudC5kZWZhdWx0Vmlldy5zZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocG9wVXBXaW5kb3cuY2xvc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMuX2RvY3VtZW50LmRlZmF1bHRWaWV3LmNsZWFySW50ZXJ2YWwocG9sbFRpbWVyKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgIC8vIEVtaXQgd2hlbiBzaGFyZSB3aW5kb3dzIGlzIGNsb3NlZFxyXG4gICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlZC5lbWl0KHRoaXMuc2hhcmVCdXR0b25OYW1lKTtcclxuICAgICAgICAgICAgICAgICAgc3ViLm5leHQoKTtcclxuICAgICAgICAgICAgICAgICAgc3ViLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSwgMjAwKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gRW1pdCB3aGVuIHNoYXJlIHdpbmRvdyBpcyBvcGVuZWRcclxuICAgICAgdGhpcy5vcGVuZWQuZW1pdCh0aGlzLnNoYXJlQnV0dG9uTmFtZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gRU1QVFk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9zZXJpYWxpemVQYXJhbXMocGFyYW1zOiBTaGFyZVBhcmFtcyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXModGhpcy5zaGFyZUJ1dHRvbi5wYXJhbXMpXHJcbiAgICAubWFwKChba2V5LCB2YWx1ZV0pID0+IHtcclxuICAgICAgLy8gQ2hlY2sgaWYgc2hhcmUgYnV0dG9uIHBhcmFtIGhhcyBhIG1hcCBmdW5jdGlvblxyXG4gICAgICBjb25zdCBwYXJhbUZ1bmM6IFNoYXJlUGFyYW1zRnVuYyA9IHRoaXMuc2hhcmVCdXR0b24ucGFyYW1zRnVuYyA/IHRoaXMuc2hhcmVCdXR0b24ucGFyYW1zRnVuY1trZXldIDogbnVsbDtcclxuXHJcbiAgICAgIGlmIChwYXJhbXNba2V5XSB8fCBwYXJhbUZ1bmMpIHtcclxuICAgICAgICBjb25zdCBwYXJhbVZhbHVlID0gcGFyYW1GdW5jID8gcGFyYW1GdW5jKHBhcmFtcykgOiBwYXJhbXNba2V5XTtcclxuICAgICAgICByZXR1cm4gYCR7IHZhbHVlIH09JHsgZW5jb2RlVVJJQ29tcG9uZW50KHBhcmFtVmFsdWUpIH1gO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH0pXHJcbiAgICAuZmlsdGVyKHVybFBhcmFtID0+IHVybFBhcmFtICE9PSAnJylcclxuICAgIC5qb2luKCcmJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==